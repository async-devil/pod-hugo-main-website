variables:
  GIT_SUBMODULE_STRATEGY: recursive
  TAG_LATEST_DEV: registry.pod.cvut.cz/internal/pod-o-lee/main-web-dev:latest
  TAG_COMMIT_DEV: registry.pod.cvut.cz/internal/pod-o-lee/main-web-dev:$CI_COMMIT_SHORT_SHA
  TAG_LATEST_PROD: registry.pod.cvut.cz/internal/pod-o-lee/main-web-prod:latest
  TAG_COMMIT_PROD: registry.pod.cvut.cz/internal/pod-o-lee/main-web-prod:$CI_COMMIT_SHORT_SHA

stages:
  - build
  - deploy

build_dev:
  stage: build
  image: registry.pod.cvut.cz/cache/library/docker:20.10
  script:
    - DOCKER_BUILDKIT=1 docker build --target hugo_prod -t $TAG_COMMIT_DEV -t $TAG_LATEST_DEV --build-arg hugo_env=develop --build-arg BUILDKIT_INLINE_CACHE=1 --cache-from $TAG_LATEST_DEV .
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD registry.pod.cvut.cz
    - docker push $TAG_COMMIT_DEV
    - docker push $TAG_LATEST_DEV
  only:
    - develop

build_prod:
  stage: build
  image: registry.pod.cvut.cz/cache/library/docker:20.10
  script:
    - DOCKER_BUILDKIT=1 docker build --target hugo_prod -t $TAG_COMMIT_PROD -t $TAG_LATEST_PROD --build-arg hugo_env=production --build-arg BUILDKIT_INLINE_CACHE=1 --cache-from $TAG_LATEST_PROD .
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD registry.pod.cvut.cz
    - docker push $TAG_COMMIT_PROD
    - docker push $TAG_LATEST_PROD
  only:
    - main

deploy_dev:
  stage: deploy
  image: registry.pod.cvut.cz/cache/library/alpine:latest
  script:
    - chmod og= $DOCKER_DEPLOYER_PRIVATE_KEY
    - apk update && apk add openssh-client
    - ssh -i $DOCKER_DEPLOYER_PRIVATE_KEY -o StrictHostKeyChecking=no -p $DOCKER_SERVER_HOST_SSH_PORT $DOCKER_DEPLOYER_USER@$DOCKER_SERVER_HOST "docker service rm main-web-dev || true"
    - ssh -i $DOCKER_DEPLOYER_PRIVATE_KEY -o StrictHostKeyChecking=no -p $DOCKER_SERVER_HOST_SSH_PORT $DOCKER_DEPLOYER_USER@$DOCKER_SERVER_HOST "docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD registry.pod.cvut.cz"
    - ssh -i $DOCKER_DEPLOYER_PRIVATE_KEY -o StrictHostKeyChecking=no -p $DOCKER_SERVER_HOST_SSH_PORT $DOCKER_DEPLOYER_USER@$DOCKER_SERVER_HOST "docker service create --with-registry-auth --name main-web-dev --publish published=8005,target=80 --restart-condition on-failure $TAG_COMMIT_DEV"
  environment:
    name: development
    url: https://new.pod.cvut.cz
  only:
    - develop
  when: on_success

deploy_prod:
  stage: deploy
  image: registry.pod.cvut.cz/cache/library/alpine:latest
  script:
    - chmod og= $DOCKER_DEPLOYER_PRIVATE_KEY
    - apk update && apk add openssh-client
    - ssh -i $DOCKER_DEPLOYER_PRIVATE_KEY -o StrictHostKeyChecking=no -p $DOCKER_SERVER_HOST_SSH_PORT $DOCKER_DEPLOYER_USER@$DOCKER_SERVER_HOST "docker service rm main-web-prod || true"
    - ssh -i $DOCKER_DEPLOYER_PRIVATE_KEY -o StrictHostKeyChecking=no -p $DOCKER_SERVER_HOST_SSH_PORT $DOCKER_DEPLOYER_USER@$DOCKER_SERVER_HOST "docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD registry.pod.cvut.cz"
    - ssh -i $DOCKER_DEPLOYER_PRIVATE_KEY -o StrictHostKeyChecking=no -p $DOCKER_SERVER_HOST_SSH_PORT $DOCKER_DEPLOYER_USER@$DOCKER_SERVER_HOST "docker service create --with-registry-auth --name main-web-prod --publish published=8004,target=80 --restart-condition on-failure $TAG_COMMIT_PROD"
  environment:
    name: production
    url: https://pod.cvut.cz
  only:
    - main
  when: on_success
